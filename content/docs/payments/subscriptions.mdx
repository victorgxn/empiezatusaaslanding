---
title: Suscripciones
description: Implementa planes de suscripción recurrentes
---

import { Callout } from 'fumadocs-ui/components/callout';

# Suscripciones

Las suscripciones permiten cobrar de forma recurrente a tus usuarios.

## Modelo de datos

```prisma title="prisma/schema.prisma"
model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  stripeCustomerId     String    @unique
  stripeSubscriptionId String?   @unique
  stripePriceId        String?
  status               String?   // active, canceled, past_due, etc.
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
```

## Verificar estado de suscripción

```typescript title="lib/subscription.ts"
import { db } from "@/lib/db";
import { stripe } from "@/lib/stripe";

export async function getUserSubscription(userId: string) {
  const subscription = await db.subscription.findUnique({
    where: { userId },
  });

  if (!subscription) {
    return { isActive: false, plan: null };
  }

  // Verificar si está activa
  const isActive =
    subscription.status === "active" ||
    subscription.status === "trialing";

  // Verificar si ha expirado
  const hasExpired =
    subscription.currentPeriodEnd &&
    new Date(subscription.currentPeriodEnd) < new Date();

  return {
    isActive: isActive && !hasExpired,
    plan: subscription.stripePriceId,
    status: subscription.status,
    currentPeriodEnd: subscription.currentPeriodEnd,
    cancelAtPeriodEnd: subscription.cancelAtPeriodEnd,
  };
}
```

## Hook para verificar suscripción

```tsx title="hooks/use-subscription.ts"
"use client";

import { useEffect, useState } from "react";

interface Subscription {
  isActive: boolean;
  plan: string | null;
  status: string | null;
  currentPeriodEnd: Date | null;
}

export function useSubscription() {
  const [subscription, setSubscription] = useState<Subscription | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetch("/api/subscription")
      .then((res) => res.json())
      .then(setSubscription)
      .finally(() => setLoading(false));
  }, []);

  return { subscription, loading };
}
```

## API para verificar suscripción

```typescript title="app/api/subscription/route.ts"
import { auth } from "@/lib/auth";
import { headers } from "next/headers";
import { getUserSubscription } from "@/lib/subscription";

export async function GET() {
  const session = await auth.api.getSession({
    headers: await headers(),
  });

  if (!session?.user) {
    return Response.json({ error: "No autenticado" }, { status: 401 });
  }

  const subscription = await getUserSubscription(session.user.id);

  return Response.json(subscription);
}
```

## Proteger funcionalidades premium

```tsx title="components/premium-feature.tsx"
"use client";

import { useSubscription } from "@/hooks/use-subscription";
import { Button } from "@/components/ui/button";
import Link from "next/link";

export function PremiumFeature({ children }: { children: React.ReactNode }) {
  const { subscription, loading } = useSubscription();

  if (loading) {
    return <div>Cargando...</div>;
  }

  if (!subscription?.isActive) {
    return (
      <div className="border rounded-lg p-6 text-center space-y-4">
        <h3 className="font-semibold">Función Premium</h3>
        <p className="text-muted-foreground">
          Actualiza tu plan para acceder a esta funcionalidad
        </p>
        <Button asChild>
          <Link href="/pricing">Ver planes</Link>
        </Button>
      </div>
    );
  }

  return <>{children}</>;
}
```

## Server Component protegido

```tsx title="app/dashboard/analytics/page.tsx"
import { auth } from "@/lib/auth";
import { headers } from "next/headers";
import { redirect } from "next/navigation";
import { getUserSubscription } from "@/lib/subscription";

export default async function AnalyticsPage() {
  const session = await auth.api.getSession({
    headers: await headers(),
  });

  if (!session?.user) {
    redirect("/login");
  }

  const subscription = await getUserSubscription(session.user.id);

  if (!subscription.isActive) {
    redirect("/pricing?feature=analytics");
  }

  return (
    <div>
      <h1>Analytics</h1>
      {/* Contenido premium */}
    </div>
  );
}
```

## Cambiar de plan

```typescript title="app/api/stripe/change-plan/route.ts"
import { stripe } from "@/lib/stripe";
import { db } from "@/lib/db";
import { auth } from "@/lib/auth";
import { headers } from "next/headers";

export async function POST(request: Request) {
  const session = await auth.api.getSession({
    headers: await headers(),
  });

  if (!session?.user) {
    return Response.json({ error: "No autenticado" }, { status: 401 });
  }

  const { newPriceId } = await request.json();

  const subscription = await db.subscription.findUnique({
    where: { userId: session.user.id },
  });

  if (!subscription?.stripeSubscriptionId) {
    return Response.json(
      { error: "No hay suscripción activa" },
      { status: 400 }
    );
  }

  // Obtener suscripción de Stripe
  const stripeSubscription = await stripe.subscriptions.retrieve(
    subscription.stripeSubscriptionId
  );

  // Actualizar el precio
  await stripe.subscriptions.update(subscription.stripeSubscriptionId, {
    items: [
      {
        id: stripeSubscription.items.data[0].id,
        price: newPriceId,
      },
    ],
    proration_behavior: "create_prorations",
  });

  return Response.json({ success: true });
}
```

<Callout type="info">
  Los cambios de plan se manejan con prorrateo automático por defecto. Stripe ajustará los cobros según el tiempo restante del periodo actual.
</Callout>
