---
title: Two-Factor Authentication
description: Añade una capa extra de seguridad con 2FA
---

import { Callout } from 'fumadocs-ui/components/callout';
import { Steps, Step } from 'fumadocs-ui/components/steps';

# Two-Factor Authentication

El 2FA añade una capa adicional de seguridad requiriendo un código temporal además de la contraseña.

## Tipos de 2FA

Better Auth soporta:

- **TOTP**: Códigos temporales con apps como Google Authenticator
- **Backup codes**: Códigos de respaldo para emergencias

## Configuración

<Steps>
  <Step>
    ### Habilitar el plugin

    ```typescript title="lib/auth.ts"
    import { betterAuth } from "better-auth";
    import { twoFactor } from "better-auth/plugins";

    export const auth = betterAuth({
      // ... otras opciones
      plugins: [
        twoFactor({
          issuer: "EmpiezaTuSaaS", // Nombre que aparece en la app authenticator
          totpOptions: {
            digits: 6,
            period: 30,
          },
          backupCodes: {
            length: 10,
            characters: "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
          },
        }),
      ],
    });
    ```
  </Step>

  <Step>
    ### Actualizar el cliente

    ```typescript title="lib/auth-client.ts"
    import { createAuthClient } from "better-auth/react";
    import { twoFactorClient } from "better-auth/client/plugins";

    export const authClient = createAuthClient({
      baseURL: process.env.NEXT_PUBLIC_APP_URL,
      plugins: [twoFactorClient()],
    });
    ```
  </Step>

  <Step>
    ### Actualizar schema de Prisma

    ```prisma title="prisma/schema.prisma"
    model User {
      // ... campos existentes
      twoFactorEnabled Boolean @default(false)
      twoFactorSecret  String?
      backupCodes      String?
    }
    ```

    ```bash
    npx prisma migrate dev --name add-2fa
    ```
  </Step>
</Steps>

## Habilitar 2FA para un usuario

```tsx title="components/settings/enable-2fa.tsx"
"use client";

import { useState } from "react";
import { authClient } from "@/lib/auth-client";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import QRCode from "qrcode.react";

export function Enable2FA() {
  const [step, setStep] = useState<"initial" | "verify" | "backup">("initial");
  const [totpURI, setTotpURI] = useState("");
  const [backupCodes, setBackupCodes] = useState<string[]>([]);
  const [code, setCode] = useState("");

  const handleEnable = async () => {
    const { data } = await authClient.twoFactor.enable();
    if (data?.totpURI) {
      setTotpURI(data.totpURI);
      setStep("verify");
    }
  };

  const handleVerify = async () => {
    const { data } = await authClient.twoFactor.verifyTotp({
      code,
    });

    if (data?.backupCodes) {
      setBackupCodes(data.backupCodes);
      setStep("backup");
    }
  };

  if (step === "initial") {
    return (
      <div className="space-y-4">
        <h3 className="font-semibold">Autenticación de dos factores</h3>
        <p className="text-muted-foreground">
          Añade una capa extra de seguridad a tu cuenta
        </p>
        <Button onClick={handleEnable}>Habilitar 2FA</Button>
      </div>
    );
  }

  if (step === "verify") {
    return (
      <div className="space-y-4">
        <h3 className="font-semibold">Escanea el código QR</h3>
        <p className="text-muted-foreground">
          Usa una app como Google Authenticator o Authy
        </p>

        <div className="flex justify-center p-4 bg-white rounded-lg">
          <QRCode value={totpURI} size={200} />
        </div>

        <div className="space-y-2">
          <label className="text-sm font-medium">
            Ingresa el código de 6 dígitos
          </label>
          <Input
            type="text"
            placeholder="000000"
            value={code}
            onChange={(e) => setCode(e.target.value)}
            maxLength={6}
          />
        </div>

        <Button onClick={handleVerify} disabled={code.length !== 6}>
          Verificar y activar
        </Button>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      <h3 className="font-semibold">2FA Activado</h3>
      <p className="text-muted-foreground">
        Guarda estos códigos de respaldo en un lugar seguro.
        Solo se mostrarán una vez.
      </p>

      <div className="grid grid-cols-2 gap-2 p-4 bg-muted rounded-lg font-mono text-sm">
        {backupCodes.map((code, i) => (
          <div key={i}>{code}</div>
        ))}
      </div>

      <Callout type="warn">
        Si pierdes acceso a tu app de autenticación, necesitarás estos códigos
        para recuperar tu cuenta.
      </Callout>

      <Button onClick={() => window.location.reload()}>Listo</Button>
    </div>
  );
}
```

## Verificar 2FA en login

```tsx title="components/auth/verify-2fa.tsx"
"use client";

import { useState } from "react";
import { authClient } from "@/lib/auth-client";
import { useRouter } from "next/navigation";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";

export function Verify2FA() {
  const [code, setCode] = useState("");
  const [useBackup, setUseBackup] = useState(false);
  const [loading, setLoading] = useState(false);
  const router = useRouter();

  const handleVerify = async () => {
    setLoading(true);

    const { error } = useBackup
      ? await authClient.twoFactor.verifyBackupCode({ code })
      : await authClient.twoFactor.verifyTotp({ code });

    if (!error) {
      router.push("/dashboard");
    }

    setLoading(false);
  };

  return (
    <div className="space-y-4">
      <h2 className="text-xl font-semibold">Verificación de dos factores</h2>

      {!useBackup ? (
        <>
          <p className="text-muted-foreground">
            Ingresa el código de 6 dígitos de tu app de autenticación
          </p>
          <Input
            type="text"
            placeholder="000000"
            value={code}
            onChange={(e) => setCode(e.target.value)}
            maxLength={6}
          />
        </>
      ) : (
        <>
          <p className="text-muted-foreground">
            Ingresa uno de tus códigos de respaldo
          </p>
          <Input
            type="text"
            placeholder="XXXX-XXXX"
            value={code}
            onChange={(e) => setCode(e.target.value)}
          />
        </>
      )}

      <Button onClick={handleVerify} disabled={loading} className="w-full">
        {loading ? "Verificando..." : "Verificar"}
      </Button>

      <button
        onClick={() => setUseBackup(!useBackup)}
        className="text-sm text-muted-foreground hover:underline"
      >
        {useBackup ? "Usar app de autenticación" : "Usar código de respaldo"}
      </button>
    </div>
  );
}
```

## Deshabilitar 2FA

```typescript
const disable2FA = async (password: string) => {
  await authClient.twoFactor.disable({
    password, // Requiere contraseña por seguridad
  });
};
```

<Callout type="info">
  Se recomienda habilitar 2FA para todos los usuarios que manejen información sensible o tengan roles administrativos.
</Callout>
